/****************************************Copyright (c)*************************
**                               版权所?(C), 2015-2020, 涂鸦科技
**
**                                 http://www.tuya.com
**
**--------------文件信息-------------------------------------------------------
**?  ?  ? protocol.h
**?       ? 下发/上报数据处理函数
**????:

                  *******非常重要，一定要看哦！！?*******

** 1、用户在此文件中实现数据下发/上报功能
** 2、DP的ID/TYPE及数据处理函数都需要用户按照实际定义实?
** 3、当开始某些宏定义后需要用户实现代码的函数内部?err提示,完成函数后请删除?err
**
**--------------当前版本修订---------------------------------------------------
** ? ? v2.5.1
** 日　? 2018?0?7?
** 描　? 1:默认关闭流服务功?
           2:增加03协议wifi状态宏定义
		   3:更新与修改部分函数注?
		   
** ? ? v2.5.0
** 日　? 2018??8?
** 描　? 1:协议版本改为0x03
           2:增加WIFI模组心跳关闭功能
           3:增加天气功能

** ? ? v2.3.8
** 日　? 2018??7?
** 描　? 1:变量添加volatile防止编译器优?
           2:添加#error提示

** ? ? v2.3.7
** 日　? 2017??8?
** 描　? 1:优化串口队列接收处理
		   
** ? ? v2.3.6
** 日　? 2016??1?
** 描　? 1:修复获取本地时间错误
           2:添加hex_to_bcd转换函数
		   
** ? ? v2.3.5
** 日　? 2016???
** 描　? 1:修改返回协议版本?x01
           2:固件升级数据偏移量修改为4字节

** ? ? v2.3.4
** 日　? 2016??6?
** 描　? 1:优化串口解析函数
           2:优化编译器兼容?取消enum类型定义

** ? ? v2.3.3
** 日　? 2016??4?
** 描　? 1:修改mcu获取本地时间函数
           2:添加wifi功能测试

** ? ? v2.3.2
** 日　? 2016??3?
** 描　? 1:优化串口数据解析
           2:优化MCU固件升级流程
           3:优化上报流程

** ? ? v2.3.1
** 日　? 2016??5?
** 描　? 1:优化串口数据解析

** ? ? v2.3
** 日　? 2016??4?
** 描　? 1:支持MCU固件在线升级

** ? ? v2.2
** 日　? 2016??1?
** 描　? 1:修改串口数据接收方式

** ? ? v2.1
** 日　? 2016???
** 描　? 1:加入某些编译器不支持函数指针兼容选项

** ? ? v2.0
** 日　? 2016??9?
** 描　? 1:优化代码结构
           2:节省RAM空间
**
**-----------------------------------------------------------------------------
******************************************************************************/
#ifndef __PROTOCOL_H_
#define __PROTOCOL_H_



/******************************************************************************
                            用户相关信息配置
******************************************************************************/
/******************************************************************************
                            1:修改产品信息                
******************************************************************************/
#define PRODUCT_KEY "hwumoz2vfhi7arvh"    //开发平台创建产品后生成?6位字符产品唯一标识

#define MCU_VER "1.0.0"                                 //用户的软件版?用于MCU固件升级,MCU升级版本需修改

//配网方式选择,默认为CONFIG_MODE_DEFAULT,只能三选一
#define CONFIG_MODE     CONFIG_MODE_DEFAULT             //默认配网方式
//#define CONFIG_MODE     CONFIG_MODE_LOWPOWER            //低功耗配网方?
//#define CONFIG_MODE     CONFIG_MODE_SPECIAL             //特殊配网方式

/******************************************************************************
                          2:MCU是否需要支固件升级                  
如需要支持MCU固件升级,请开启该?
MCU可调用mcu_api.c文件内的mcu_firm_update_query()函数获取当前MCU固件更新情况
                        ********WARNING!!!**********
当前接收缓冲区为关闭固件更新功能的大?固件升级包为256字节
如需要开启该功能,串口接收缓冲区会变大
******************************************************************************/
//#define         SUPPORT_MCU_FIRM_UPDATE                 //开启MCU固件升级功能(默认关闭)
/******************************************************************************
                         3:定义收发缓存:
                    如当前使用MCU的RAM不够,可修改为24
******************************************************************************/
#ifndef SUPPORT_MCU_FIRM_UPDATE
#define WIFI_UART_QUEUE_LMT             16              //数据接收队列大小,如MCU的RAM不够,可缩?
#define WIFI_UART_RECV_BUF_LMT          24              //根据用户DP数据大小量定,必须大于24
#else
#define WIFI_UART_QUEUE_LMT             128             //数据接收队列大小,如MCU的RAM不够,可缩?
#define WIFI_UART_RECV_BUF_LMT          300             //固件升级缓冲?需大缓?必须大于260
#endif

#define WIFIR_UART_SEND_BUF_LMT         48              //根据用户DP数据大小量定,必须大于48
/******************************************************************************
                        4:定义模块工作方式
模块自处?
          wifi指示灯和wifi复位按钮接在wifi模块?开启WIFI_CONTROL_SELF_MODE?
          并正确定义WF_STATE_KEY和WF_RESET_KEY
MCU自处?
          wifi指示灯和wifi复位按钮接在MCU?关闭WIFI_CONTROL_SELF_MODE?
          MCU在需要处理复位wifi的地方调用mcu_api.c文件内的mcu_reset_wifi()函数,并可调用mcu_get_reset_wifi_flag()函数返回复位wifi结果
          或调用设置wifi模式mcu_api.c文件内的mcu_set_wifi_mode(WIFI_CONFIG_E mode)函数,并可调用mcu_get_wifi_work_state()函数返回设置wifi结果
******************************************************************************/
//#define         WIFI_CONTROL_SELF_MODE                       //wifi自处理按键及LED指示?如为MCU外界按键/LED指示灯请关闭该宏
#ifdef          WIFI_CONTROL_SELF_MODE                      //模块自处?
  #define     WF_STATE_KEY            14                    //wifi模块状态指示按键，请根据实际GPIO管脚设置
  #define     WF_RESERT_KEY           0                     //wifi模块重置按键，请根据实际GPIO管脚设置
#endif

/******************************************************************************
                      5:MCU是否需要支持校时功?                    
如需要请开启该?并在Protocol.c文件内mcu_write_rtctime实现代码
mcu_write_rtctime内部?err提示,完成函数后请删除?err
mcu在wifi模块正确联网后可调用mcu_get_system_time()函数发起校时功能
******************************************************************************/
//#define         SUPPORT_MCU_RTC_CHECK                //开启校时功?

/******************************************************************************
                      6:MCU是否需要支持wifi功能测试                     
如需要请开启该?并且mcu在需要wifi功能测试处调用mcu_api.c文件内mcu_start_wifitest
并在protocol.c文件wifi_test_result函数内查看测试结?
wifi_test_result内部?err提示,完成函数后请删除?err
******************************************************************************/
#define         WIFI_TEST_ENABLE                //开启WIFI产测功能

/******************************************************************************
                      7:是否开启天气功?                  
如需要请开启该?并在protocol.c文件内weather_open_return_handle与weather_data_u\
ser_handle两个用户处理函数中实现显示等代码
此两函数?err提示,完成函数后请删除?err
******************************************************************************/
//#define         WEATHER_ENABLE                 //打开天气功能
#ifdef          WEATHER_ENABLE
#define         WEATHER_CHOOSE_CNT             4
#endif

/******************************************************************************
                      8:是否开启WIFI模组心跳关闭功能                   
如需要请开启该?调用mcu_api.c文件内wifi_heart_stop函数即可停止心跳
******************************************************************************/
//#define         WIFI_HEARTSTOP_ENABLE           //开启心跳停止功?

/******************************************************************************
                      9:是否支持流服务功?                
******************************************************************************/
#define         WIFI_STREAM_ENABLE              //支持流服务相关功?
#ifdef WIFI_STREAM_ENABLE
#define         STREM_PACK_LEN                 256
#endif

/******************************************************************************
                        1:dp数据点序列号重新定义
          **此为自动生成代码,如在开发平台有相关修改请重新下载MCU_SDK**         
******************************************************************************/
//电源开?可下发可上报)
//备注:【非必选?
//"可选择无开关机功能?
//开关机控制?
//下发?发送控制指令给主机，主机依据指令状态进行开关机操作?
//上报?
//当主机使用遥控器关机或者长时间静止进入关机状态后，主机会上报一个关机数据?
//当主机处于关机状态时，通过遥控器或者触摸主机的按键，主机会进入开机状态，主机会上报一个开机数据?

#define DPID_POWER 1
//清扫开?可下发可上报)
//备注:【必选?

#define DPID_POWER_GO 2
//清扫模式(可下发可上报)
//备注:【必选】枚举值按需选择，不需要的可删?
//smart：自动清扫， wall_follow：沿边清??spiral:定点清扫, chargego:回充模式

#define DPID_MODE 3
//方向(可下发可上报)
//备注:【必选?
//"前进，后退，左转，右转，停止?
//默认逻辑：按住方向键下发 ??左转/右转，手指抬起下发停?


#define DPID_DIRECTION_CONTROL 4
//工作状?只上?
//备注:休眠、待机、工作中、回充中、充电完成、座充中、直充中、故障、其他故?

#define DPID_STATUS 5
//剩余电量(只上?
//备注:【必选?
#define DPID_ELECTRICITY_LEFT 6
//吸力选择(可下发可上报)
//备注:【非必选?

#define DPID_SUCTION 14
//清扫记录(只上?
//备注:可选择将地图ID号同时上?
//清扫日期+ YYYYMMDDTTRR 清扫时长 + XXX 清扫面积 xxx 如： "20180411051102008000020" 代表2018??1?5?1分，清扫?0分钟?0平方?，id号为20（假如MCU没有RTC，时间可不上报。记录则默认显示为数据上报时间）
#define DPID_CLEAN_RECORD 15
//清扫面积(只上?
//备注:【非必选?
//需要兼容一位小数显?
#define DPID_CLEAN_AREA 16
//清扫时间(只上?
//备注:【非必选?
//MCU上报本次清扫时间，实时更?

#define DPID_CLEAN_TIME 17
//故障告警(只上?
//备注:1、左主动轮过载；
//2、右主动轮过载；
//3、边刷过载；
//4、碰撞开关异常；
//5、地检异常?
//6、风扇过载；
//7、滚刷过载；
//8、垃圾盒未装好；
//9、电量过低；
//10、其他故?

#define DPID_FAULT 18
//地图参数(只上?
//备注:【有地图则必选】如果扫地机有地图功能，需要选择此功能点，用于配置地图参数，具体格式如下?
//?个字?第一个字节为原点?,0）位置，二三字节为地图最大的长宽
//0x00 左上?
//0x01 左下?
 //例：0x0000ff  左上角，最大长宽值为255
#define DPID_MAP_CONFIG 19


/*****************************************************************************
函数名称 : all_data_update
功能描述 : 系统所有dp点信息上?
输入参数 : ?
返回参数 : ?
使用说明 : MCU必须实现该函数内数据上报功能
*****************************************************************************/
void all_data_update(void);

#ifdef SUPPORT_MCU_RTC_CHECK
/*****************************************************************************
函数名称 : mcu_write_rtctime
功能描述 : MCU校对本地RTC时钟
输入参数 : ?
返回参数 : ?
使用说明 : MCU需要自行实现该功能
*****************************************************************************/
void mcu_write_rtctime(unsigned char time[]);
#endif

#ifdef WIFI_TEST_ENABLE
/*****************************************************************************
函数名称 : wifi_test_result
功能描述 : wifi功能测试反馈
输入参数 : result:wifi功能测试结果;0:失败/1:成功
           rssi:测试成功表示wifi信号强度/测试失败表示错误类型
返回参数 : ?
使用说明 : MCU需要自行实现该功能
*****************************************************************************/
void wifi_test_result(unsigned char result,unsigned char rssi);
#endif

#ifdef SUPPORT_MCU_FIRM_UPDATE
/*****************************************************************************
函数名称 : mcu_firm_update_handle
功能描述 : MCU进入固件升级模式
输入参数 : value:固件缓冲?
           position:当前数据包在于固件位?
           length:当前固件包长?固件包长度为0?表示固件包发送完?
返回参数 : ?
使用说明 : MCU需要自行实现该功能
*****************************************************************************/
unsigned char mcu_firm_update_handle(const unsigned char value[],unsigned long position,unsigned short length);
#endif

/*****************************************************************************
函数名称 : dp_download_handle
功能描述 : dp下发处理函数
输入参数 : dpid:DP序号
value:dp数据缓冲区地址
length:dp数据长度
返回参数 : 成功返回:SUCCESS/失败返回:ERRO
使用说明 : 该函数用户不能修?
*****************************************************************************/
unsigned char dp_download_handle(unsigned char dpid,const unsigned char value[], unsigned short length);
/*****************************************************************************
函数名称 : get_download_cmd_total
功能描述 : 获取所有dp命令总和
输入参数 : ?
返回参数 : 下发命令总和
使用说明 : 该函数用户不能修?
*****************************************************************************/
unsigned char get_download_cmd_total(void);

#ifdef WEATHER_ENABLE
extern const char weather_choose[WEATHER_CHOOSE_CNT][10];

void weather_open_return_handle(unsigned char res, unsigned char err);
void weather_data_user_handle(char *name, unsigned char type, char *data);
#endif

#endif

