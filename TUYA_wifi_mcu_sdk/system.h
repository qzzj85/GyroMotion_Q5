/****************************************Copyright (c)*************************
**                               ç‰ˆæƒæ‰€æœ?(C), 2015-2020, æ¶‚é¸¦ç§‘æŠ€
**
**                                 http://www.tuya.com
**
**--------------æ–‡ä»¶ä¿¡æ¯-------------------------------------------------------
**æ–?  ä»?  å? system.c
**æ?       è¿? wifiæ•°æ®å¤„ç†å‡½æ•°
**ä½?ç”?è¯?æ˜?: ç”¨æˆ·æ— éœ€å…³å¿ƒè¯¥æ–‡ä»¶å®ç°å†…å®?
**
**
**--------------å½“å‰ç‰ˆæœ¬ä¿®è®¢---------------------------------------------------
** ç‰? æœ? v2.5.1
** æ—¥ã€€æœ? 2018å¹?0æœ?7æ—?
** æã€€è¿? 1:é»˜è®¤å…³é—­æµæœåŠ¡åŠŸèƒ?
           2:å¢åŠ 03åè®®wifiçŠ¶æ€å®å®šä¹‰
		   3:æ›´æ–°ä¸ä¿®æ”¹éƒ¨åˆ†å‡½æ•°æ³¨é‡?
		   
** ç‰? æœ? v2.5.0
** æ—¥ã€€æœ? 2018å¹?æœ?8æ—?
** æã€€è¿? 1:åè®®ç‰ˆæœ¬æ”¹ä¸º0x03
           2:å¢åŠ WIFIæ¨¡ç»„å¿ƒè·³å…³é—­åŠŸèƒ½
           3:å¢åŠ å¤©æ°”åŠŸèƒ½

** ç‰? æœ? v2.3.8
** æ—¥ã€€æœ? 2018å¹?æœ?7æ—?
** æã€€è¿? 1:å˜é‡æ·»åŠ volatileé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ?
           2:æ·»åŠ #erroræç¤º

** ç‰? æœ? v2.3.7
** æ—¥ã€€æœ? 2017å¹?æœ?8æ—?
** æã€€è¿? 1:ä¼˜åŒ–ä¸²å£é˜Ÿåˆ—æ¥æ”¶å¤„ç†
		   
** ç‰? æœ? v2.3.6
** æ—¥ã€€æœ? 2016å¹?æœ?1æ—?
** æã€€è¿? 1:ä¿®å¤è·å–æœ¬åœ°æ—¶é—´é”™è¯¯
           2:æ·»åŠ hex_to_bcdè½¬æ¢å‡½æ•°
		   
** ç‰? æœ? v2.3.5
** æ—¥ã€€æœ? 2016å¹?æœ?æ—?
** æã€€è¿? 1:ä¿®æ”¹è¿”å›åè®®ç‰ˆæœ¬ä¸?x01
           2:å›ºä»¶å‡çº§æ•°æ®åç§»é‡ä¿®æ”¹ä¸º4å­—èŠ‚

** ç‰? æœ? v2.3.4
** æ—¥ã€€æœ? 2016å¹?æœ?6æ—?
** æã€€è¿? 1:ä¼˜åŒ–ä¸²å£è§£æå‡½æ•°
           2:ä¼˜åŒ–ç¼–è¯‘å™¨å…¼å®¹æ€?å–æ¶ˆenumç±»å‹å®šä¹‰

** ç‰? æœ? v2.3.3
** æ—¥ã€€æœ? 2016å¹?æœ?4æ—?
** æã€€è¿? 1:ä¿®æ”¹mcuè·å–æœ¬åœ°æ—¶é—´å‡½æ•°
           2:æ·»åŠ wifiåŠŸèƒ½æµ‹è¯•

** ç‰? æœ? v2.3.2
** æ—¥ã€€æœ? 2016å¹?æœ?3æ—?
** æã€€è¿? 1:ä¼˜åŒ–ä¸²å£æ•°æ®è§£æ
           2:ä¼˜åŒ–MCUå›ºä»¶å‡çº§æµç¨‹
           3:ä¼˜åŒ–ä¸ŠæŠ¥æµç¨‹

** ç‰? æœ? v2.3.1
** æ—¥ã€€æœ? 2016å¹?æœ?5æ—?
** æã€€è¿? 1:ä¼˜åŒ–ä¸²å£æ•°æ®è§£æ

** ç‰? æœ? v2.3
** æ—¥ã€€æœ? 2016å¹?æœ?4æ—?
** æã€€è¿? 1:æ”¯æŒMCUå›ºä»¶åœ¨çº¿å‡çº§

** ç‰? æœ? v2.2
** æ—¥ã€€æœ? 2016å¹?æœ?1æ—?
** æã€€è¿? 1:ä¿®æ”¹ä¸²å£æ•°æ®æ¥æ”¶æ–¹å¼

** ç‰? æœ? v2.1
** æ—¥ã€€æœ? 2016å¹?æœ?æ—?
** æã€€è¿? 1:åŠ å…¥æŸäº›ç¼–è¯‘å™¨ä¸æ”¯æŒå‡½æ•°æŒ‡é’ˆå…¼å®¹é€‰é¡¹

** ç‰? æœ? v2.0
** æ—¥ã€€æœ? 2016å¹?æœ?9æ—?
** æã€€è¿? 1:ä¼˜åŒ–ä»£ç ç»“æ„
2:èŠ‚çœRAMç©ºé—´
**
**-----------------------------------------------------------------------------
******************************************************************************/
#ifndef __SYSTEM_H_
#define __SYSTEM_H_

#ifdef SYSTEM_GLOBAL
  #define SYSTEM_EXTERN
#else
  #define SYSTEM_EXTERN   extern
#endif

//=============================================================================
//å¸§çš„å­—èŠ‚é¡ºåº
//=============================================================================
#define         HEAD_FIRST                      0
#define         HEAD_SECOND                     1        
#define         PROTOCOL_VERSION                2
#define         FRAME_TYPE                      3
#define         LENGTH_HIGH                     4
#define         LENGTH_LOW                      5
#define         DATA_START                      6

//=============================================================================
//æ•°æ®å¸§ç±»å?
//=============================================================================
#define         HEAT_BEAT_CMD                   0                               //å¿ƒè·³åŒ?
#define         PRODUCT_INFO_CMD                1                               //äº§å“ä¿¡æ¯
#define         WORK_MODE_CMD                   2                               //æŸ¥è¯¢MCU è®¾å®šçš„æ¨¡å—å·¥ä½œæ¨¡å¼?
#define         WIFI_STATE_CMD                  3                               //wifiå·¥ä½œçŠ¶æ€?
#define         WIFI_RESET_CMD                  4                               //é‡ç½®wifi
#define         WIFI_MODE_CMD                   5                               //é€‰æ‹©smartconfig/APæ¨¡å¼	
#define         DATA_QUERT_CMD                  6                               //å‘½ä»¤ä¸‹å‘
#define         STATE_UPLOAD_CMD                7                               //çŠ¶æ€ä¸ŠæŠ? 
#define         STATE_QUERY_CMD                 8                               //çŠ¶æ€æŸ¥è¯?  
#define         UPDATE_QUERY_CMD                9                               //å‡çº§æŸ¥è¯¢
#define         UPDATE_START_CMD                0x0a                            //å‡çº§å¼€å§?
#define         UPDATE_TRANS_CMD                0x0b                            //å‡çº§ä¼ è¾“
#define         GET_ONLINE_TIME_CMD             0x0c                            //è·å–ç³»ç»Ÿæ—¶é—´(æ ¼æ—å¨æ²»æ—¶é—´)
#define         FACTORY_MODE_CMD                0x0d                            //è¿›å…¥äº§æµ‹æ¨¡å¼    
#define         WIFI_TEST_CMD                   0x0e                            //wifiåŠŸèƒ½æµ‹è¯•
#define         GET_LOCAL_TIME_CMD              0x1c                            //è·å–æœ¬åœ°æ—¶é—´
#define         WEATHER_OPEN_CMD                0x20                            //æ‰“å¼€å¤©æ°”          
#define         WEATHER_DATA_CMD                0x21                            //å¤©æ°”æ•°æ®
#define         HEAT_BEAT_STOP                  0x25                            //å…³é—­WIFIæ¨¡ç»„å¿ƒè·³
#define         STREAM_OPEN_CMD                 0x26                            //å¼€å¯æµæœåŠ¡åŠŸèƒ½
#define         STREAM_START_CMD                0x27                            //å¼€å¯æµæ•°æ®ä¼ è¾“
#define         STREAM_TRANS_CMD                0x28                            //æµæ•°æ®ä¼ è¾?
#define         STREAM_STOP_CMD                 0x29                            //ç»“æŸæµæ•°æ®ä¼ è¾?


//=============================================================================
#define VERSION                 0x00                                            //åè®®ç‰ˆæœ¬å?
#define PROTOCOL_HEAD           0x07                                            //å›ºå®šåè®®å¤´é•¿åº?
#define FIRM_UPDATA_SIZE        256                                            //å‡çº§åŒ…å¤§å°?
#define FRAME_FIRST             0x55
#define FRAME_SECOND            0xaa
//============================================================================= 
SYSTEM_EXTERN volatile unsigned char wifi_queue_buf[PROTOCOL_HEAD + WIFI_UART_QUEUE_LMT];  //ä¸²å£é˜Ÿåˆ—ç¼“å­˜
SYSTEM_EXTERN volatile unsigned char wifi_uart_rx_buf[PROTOCOL_HEAD + WIFI_UART_RECV_BUF_LMT];         //ä¸²å£æ¥æ”¶ç¼“å­˜
//SYSTEM_EXTERN volatile unsigned char wifi_uart_rx_buf[128]; 

SYSTEM_EXTERN volatile unsigned char wifi_uart_tx_buf[PROTOCOL_HEAD + WIFIR_UART_SEND_BUF_LMT];        //ä¸²å£å‘é€ç¼“å­?
//
SYSTEM_EXTERN volatile unsigned char *queue_in;
SYSTEM_EXTERN volatile unsigned char *queue_out;

SYSTEM_EXTERN volatile unsigned char stop_update_flag;

#ifndef WIFI_CONTROL_SELF_MODE
SYSTEM_EXTERN volatile unsigned char reset_wifi_flag;                                                  //é‡ç½®wifiæ ‡å¿—(TRUE:æˆåŠŸ/FALSE:å¤±è´¥)
SYSTEM_EXTERN volatile unsigned char set_wifimode_flag;                                                //è®¾ç½®WIFIå·¥ä½œæ¨¡å¼æ ‡å¿—(TRUE:æˆåŠŸ/FALSE:å¤±è´¥)
SYSTEM_EXTERN volatile unsigned char wifi_work_state;                                                  //wifiæ¨¡å—å½“å‰å·¥ä½œçŠ¶æ€?
#endif

#ifdef WIFI_STREAM_ENABLE
SYSTEM_EXTERN volatile char stream_status;                                                             //æµæœåŠ¡å‘åŒ…è¿”å›çŠ¶æ€?

extern void wifi_uart_write_stream_init(unsigned char  id, unsigned short map_len);


#endif

/*****************************************************************************
å‡½æ•°åç§° : set_wifi_uart_byte
åŠŸèƒ½æè¿° : å†™wifi_uartå­—èŠ‚
è¾“å…¥å‚æ•° : dest:ç¼“å­˜åŒºå…¶å®åœ°å€;
           byte:å†™å…¥å­—èŠ‚å€?
è¿”å›å‚æ•° : å†™å…¥å®Œæˆåçš„æ€»é•¿åº?
*****************************************************************************/
unsigned short set_wifi_uart_byte(unsigned short dest, unsigned char byte);

/*****************************************************************************
å‡½æ•°åç§° : set_wifi_uart_buffer
åŠŸèƒ½æè¿° : å†™wifi_uart_buffer
è¾“å…¥å‚æ•° : dest:ç›®æ ‡åœ°å€
           src:æºåœ°å€
           len:æ•°æ®é•¿åº¦
è¿”å›å‚æ•° : æ—?
*****************************************************************************/
unsigned short set_wifi_uart_buffer(unsigned short dest, unsigned char *src, unsigned short len);

/*****************************************************************************
å‡½æ•°åç§° : wifi_uart_write_frame
åŠŸèƒ½æè¿° : å‘wifiä¸²å£å‘é€ä¸€å¸§æ•°æ?
è¾“å…¥å‚æ•° : fr_type:å¸§ç±»å?
           len:æ•°æ®é•¿åº¦
è¿”å›å‚æ•° : æ—?
*****************************************************************************/
void wifi_uart_write_frame(unsigned char fr_type, unsigned short len);

/*****************************************************************************
å‡½æ•°åç§° : get_check_sum
åŠŸèƒ½æè¿° : è®¡ç®—æ ¡éªŒå’?
è¾“å…¥å‚æ•° : pack:æ•°æ®æºæŒ‡é’?
           pack_len:è®¡ç®—æ ¡éªŒå’Œé•¿åº?
è¿”å›å‚æ•° : æ ¡éªŒå’?
*****************************************************************************/
unsigned char get_check_sum(unsigned char *pack, unsigned short pack_len);

/*****************************************************************************
å‡½æ•°åç§° : data_handle
åŠŸèƒ½æè¿° : æ•°æ®å¸§å¤„ç?
è¾“å…¥å‚æ•° : offset:æ•°æ®èµ·å§‹ä½?
è¿”å›å‚æ•° : æ—?
*****************************************************************************/
void data_handle(unsigned short offset);

/*****************************************************************************
å‡½æ•°åç§° : get_queue_total_data
åŠŸèƒ½æè¿° : è¯»å–é˜Ÿåˆ—å†…æ•°æ?
è¾“å…¥å‚æ•° : æ—?
è¿”å›å‚æ•° : æ—?
*****************************************************************************/
unsigned char get_queue_total_data(void);

/*****************************************************************************
å‡½æ•°åç§° : Queue_Read_Byte
åŠŸèƒ½æè¿° : è¯»å–é˜Ÿåˆ—1å­—èŠ‚æ•°æ®
è¾“å…¥å‚æ•° : æ—?
è¿”å›å‚æ•° : æ—?
*****************************************************************************/
unsigned char Queue_Read_Byte(void);

#endif
  


